from midiutil.MidiFileGenerator import MidiFileGenerator, MidiTrack
from midiutil.Scales import *
from math import ceil
from random import sample


def bpm_time(bpm=120, count=0.25):
  onebar = float((60.0/float(bpm))*4.0)
  return onebar*float(count)

def scale_vec(vec, low, high):
  
  # extract min and max info
  min_vec = min(vec)
  max_vec = max(vec)

  # scale
  return [(int(ceil(v - min_vec)) * (high-low) / (max_vec - min_vec)) for v in vec]

def midify(vec, out_file="test.mid", scale=MAJOR, bpm=120, count=0.25, channel=1, min_note=30, max_note=80):
  
  # select notes
  notes = [note for note in buildScale(scale) if note >= min_note and note <= max_note]

  # scale notes
  note_indexes = scale_vec(vec, low=0, high=(len(notes)-1))

  # determinte note length
  beat = bpm_time(bpm, count)
  print beat
  # generate midi file
  m = MidiFileGenerator()
  track = MidiTrack(channel=channel, tempo=bpm)

  t = 1
  for i in note_indexes:
    n = notes[i]
    track.add_note(time=t, duration=beat, note=n, velocity=100)
    t += beat

  m.tracks.append(track)
  m.writeToFile(out_file)

if __name__ == '__main__':
  vec = [
    115286,
    137204,
    138430,
    101348,
    114623,
    109056,
    108886,
    122806,
    93566,
    107995,
    126225,
    130237,
    112605,
    113037,
    130630,
    99514,
    129204,
    101663,
    104974,
    114095,
    90444,
    115945,
    112879,
    79057,
    59622,
    71419,
    57193,
    60797,
    53201,
    46148,
    59006,
    38054,
    37388,
    2950,
    0,
    14992,
    45457,
    45479,
    34952,
    23391,
    3992,
    0,
    20381,
    22392,
    23034,
    26473,
    28412,
    28545,
    31375,
    27065,
    24763,
    17953,
    16311,
    11521,
    13958,
    11316,
    10444,
    10205,
    10587,
    8568,
    9684,
    7454,
    7147,
    4714,
    4160,
    0,
    0,
    189304,
    166178,
    160661,
    156372,
    151719,
    144097,
    110280,
    141183,
    139678,
    157149,
    120061,
    113568,
    124136,
    123561,
    124038,
    104447,
    110434,
    115768,
    110243,
    133333,
    104736,
    123521,
    104541,
    104923,
    102134,
    101307,
    93952,
    0,
    0,
    0,
    0,
    146776,
    149379,
    148196,
    150423,
    125253,
    122317,
    111262,
    121362,
    113426,
    123363,
    122173,
    113243,
    119547,
    107115,
    113224,
    148204,
    106639,
    124698,
    114358,
    120356,
    139679,
    154872,
    135502,
    144164,
    140180,
    124329,
    135362,
    119777,
    124248,
    158812,
    167949,
    160491,
    146245,
    165683,
    164430,
    149228,
    197560,
    192993,
    227565,
    193874,
    207400,
    222587,
    215233,
    218783,
    203575,
    196771,
    209504,
    183740,
    191789,
    192027,
    212847,
    189998,
    197988,
    237561,
    221827,
    216535,
    205485,
    191344,
    189720,
    171476,
    161182,
    174410,
    197019,
    189893,
    171848,
    189872,
    186833,
    210593,
    188194,
    217772,
    47575,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    50820,
    94364,
    91737,
    106845,
    124865,
    115529,
    128820,
    125681,
    121064,
    116913,
    129233,
    137465,
    120876,
    105348,
    104060,
    111103,
    113271,
    112213,
    119586,
    122714,
    121526,
    133041,
    125153,
    117873,
    106402,
    102141,
    91388,
    90046,
    68522,
    100945,
    82373,
    73031,
    62157,
    42237,
    87922,
    96245,
    93645,
    89801,
    90783,
    92483,
    102494,
    85585,
    113141,
    103756,
    119559,
    145401,
    105353,
    119577,
    142047,
    107341,
    112063,
    135141,
    123368,
    140651,
    123475,
    115916,
    114885,
    128862,
    27709,
    26056,
    25942,
    27975,
    27665,
    22068,
    0,
    3210,
    3381,
    4300,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    3989,
    2412,
    3197,
    3136,
    2872,
    3400,
    1200,
    1500,
    1700,
    1000,
    700,
    950,
    1100,
    1600,
    1280,
    1490,
    1720,
    1100,
    3000,
    1200,
    2150,
    1000,
    2500,
    300,
    660,
    550,
    1700,
    1300,
    1400,
    1000,
    1800,
    0,
    0,
    0,
    400,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    16632,
    14979,
    15709,
    11538,
    13221,
    13136,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    4450,
    4200,
    2675,
    1760,
    0,
    4035,
    14967,
    21729,
    22679,
    22679,
    0,
    10000,
    40000
  ]
  midify(vec)
